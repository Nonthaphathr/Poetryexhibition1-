<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏•‡∏≤‡∏ô‡∏ô‡∏¥‡∏ó‡∏£‡∏£‡∏®‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏â‡∏±‡∏ô‡∏ó‡πå ‡πë‡πë</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Sarabun', sans-serif;
      background-color: #FFFAF0; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏µ‡∏° */
      color: #8B4513; /* ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• */
    }
    
    /* Custom Colors classes for reuse */
    .bg-theme-brown { background-color: #8B4513; color: white; }
    .bg-theme-gold { background-color: #FFD700; color: #8B4513; }
    .bg-theme-gold-dark { background-color: #D4AF37; color: #8B4513; }
    .text-theme-brown { color: #8B4513; }
    
    .golden-glow {
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.6), 0 0 60px rgba(255, 215, 0, 0.3);
      animation: pulse-gold 2s ease-in-out infinite;
    }
    
    @keyframes pulse-gold {
      0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(255, 215, 0, 0.6), 0 0 60px rgba(255, 215, 0, 0.3); }
      50% { transform: scale(1.02); box-shadow: 0 0 40px rgba(255, 215, 0, 0.8), 0 0 80px rgba(255, 215, 0, 0.4); }
    }
    
    .heart-liked {
      color: #ef4444;
      animation: heart-beat 0.3s ease-in-out;
    }
    
    @keyframes heart-beat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }
    
    /* Masonry Layout */
    .masonry-grid {
      column-count: 1;
      column-gap: 1.5rem;
    }
    @media (min-width: 768px) { .masonry-grid { column-count: 2; } }
    @media (min-width: 1024px) { .masonry-grid { column-count: 3; } }
    
    .masonry-item {
      break-inside: avoid;
      margin-bottom: 1.5rem;
    }
  </style>
</head>

<body class="min-h-full">
  <audio id="sfx1" src="https://nonthaphathr.github.io/uploadimg/toggle-button.mp3"></audio>
  <audio id="sfx2" src="https://nonthaphathr.github.io/uploadimg/openexhibition.mp3"></audio>
  <audio id="sfx3" src="https://nonthaphathr.github.io/uploadimg/heartclick.mp3"></audio>
  <audio id="sfx4" src="https://nonthaphathr.github.io/uploadimg/commentpoet.mp3"></audio>

  <div id="page1" class="min-h-full flex flex-col items-center justify-center p-6 mt-10">
    <img id="logo" src="https://nonthaphathr.github.io/uploadimg/logokhampraphan-non.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="w-40 h-40 mb-6 object-contain">
    <h1 class="text-3xl md:text-4xl font-bold text-center mb-8 text-theme-brown">‡∏•‡∏≤‡∏ô‡∏ô‡∏¥‡∏ó‡∏£‡∏£‡∏®‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå<br>‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏â‡∏±‡∏ô‡∏ó‡πå ‡πë‡πë ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ‡πë</h1>
    
    <div class="flex flex-col gap-4 w-full max-w-md">
      <button id="visitBtn" class="bg-theme-gold-dark w-full py-4 px-6 text-lg font-bold rounded-lg shadow-lg transition-all hover:scale-105 border-2 border-[#8B4513]">
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ô‡∏¥‡∏ó‡∏£‡∏£‡∏®‡∏Å‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)
      </button> 
      <button id="registerBtn" class="bg-theme-gold w-full py-4 px-6 text-lg font-bold rounded-lg shadow-lg transition-all hover:scale-105 border-2 border-[#8B4513]">
        ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô
      </button>
    </div>
  </div>

  <div id="page2" class="hidden min-h-full flex flex-col p-6 mt-10">
    <img src="https://nonthaphathr.github.io/uploadimg/logokhampraphan-non.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="w-24 h-24 mx-auto mb-4 object-contain">
    <h2 id="welcomeMsg" class="text-2xl md:text-3xl font-bold text-center mb-8 text-theme-brown">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
    
    <div class="flex flex-col gap-4 w-full max-w-md mx-auto">
      <button id="visitExhibitionBtn" class="bg-theme-gold w-full py-4 px-6 text-lg font-bold rounded-lg shadow-lg transition-all hover:scale-105 border-2 border-[#8B4513]">
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ô‡∏¥‡∏ó‡∏£‡∏£‡∏®‡∏Å‡∏≤‡∏£
      </button> 
      <button id="submitWorkBtn" class="bg-theme-gold-dark w-full py-4 px-6 text-lg font-bold rounded-lg shadow-lg transition-all hover:scale-105 border-2 border-[#8B4513]">
        ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á
      </button>
      <button onclick="logout()" class="bg-gray-300 text-gray-700 w-full py-2 px-6 text-md font-semibold rounded-lg shadow hover:bg-gray-400 mt-4">
        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </div>
  </div>

  <div id="page3" class="hidden min-h-full p-6">
    <div class="flex justify-center mb-4">
        <img src="https://nonthaphathr.github.io/uploadimg/logokhampraphan-non.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="w-20 h-20 object-contain">
    </div>
    <h2 class="text-3xl font-bold text-center mb-6 text-theme-brown">‡∏•‡∏≤‡∏ô‡∏à‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h2>
    
    <div id="loadingExhibition" class="text-center py-12">
      <div class="inline-block w-12 h-12 border-4 border-t-transparent rounded-full animate-spin" style="border-top-color: #8B4513; border-right-color: #FFD700;"></div>
      <p class="mt-4 text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏á‡∏≤‡∏ô...</p>
    </div>
    
    <div id="exhibitionGrid" class="masonry-grid"></div>
    
    <div class="fixed bottom-6 right-6 z-40">
      <button onclick="location.reload()" class="bg-[#8B4513] text-white p-3 rounded-full shadow-lg hover:bg-[#6d360f] border-2 border-[#FFD700] flex items-center gap-2 px-4">
        üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
      </button>
    </div>
  </div>

  <div id="registerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="rounded-lg shadow-2xl p-6 w-full max-w-md bg-white text-theme-brown border-4 border-[#FFD700]">
      <h3 class="text-2xl font-bold mb-4">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
      <form id="registerForm" class="space-y-4">
        <div>
          <label for="prefix" class="block text-sm font-semibold mb-1">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label> 
          <select id="prefix" required class="w-full px-4 py-2 border-2 border-[#D4AF37] rounded-lg focus:outline-none focus:ring-2 bg-[#FFFAF0]"> 
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</option> <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢">‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option> <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á">‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option> <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option> <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option> 
          </select>
        </div>
        <div>
          <label for="firstName" class="block text-sm font-semibold mb-1">‡∏ä‡∏∑‡πà‡∏≠</label> 
          <input type="text" id="firstName" required class="w-full px-4 py-2 border-2 border-[#D4AF37] rounded-lg focus:outline-none focus:ring-2 bg-[#FFFAF0]">
        </div>
        <div>
          <label for="lastName" class="block text-sm font-semibold mb-1">‡∏™‡∏Å‡∏∏‡∏•</label> 
          <input type="text" id="lastName" required class="w-full px-4 py-2 border-2 border-[#D4AF37] rounded-lg focus:outline-none focus:ring-2 bg-[#FFFAF0]">
        </div>
        <div>
          <label for="grade" class="block text-sm font-semibold mb-1">‡∏ä‡∏±‡πâ‡∏ô</label> 
          <select id="grade" required class="w-full px-4 py-2 border-2 border-[#D4AF37] rounded-lg focus:outline-none focus:ring-2 bg-[#FFFAF0]"> 
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option> <option value="‡∏°.1">‡∏°.1</option> <option value="‡∏°.2">‡∏°.2</option> <option value="‡∏°.3">‡∏°.3</option> <option value="‡∏°.4">‡∏°.4</option> <option value="‡∏°.5">‡∏°.5</option> <option value="‡∏°.6">‡∏°.6</option> 
          </select>
        </div>
        <div>
          <label for="studentNumber" class="block text-sm font-semibold mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label> 
          <input type="number" id="studentNumber" required min="1" class="w-full px-4 py-2 border-2 border-[#D4AF37] rounded-lg focus:outline-none focus:ring-2 bg-[#FFFAF0]">
        </div>
        <div class="flex gap-3 mt-6">
          <button type="submit" id="submitRegisterBtn" class="flex-1 bg-theme-gold py-3 px-6 font-bold rounded-lg shadow hover:scale-105"> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô </button> 
          <button type="button" id="cancelRegisterBtn" class="flex-1 bg-gray-300 text-gray-700 py-3 px-6 font-bold rounded-lg shadow hover:scale-105"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
        </div>
      </form>
      <div id="registerLoading" class="hidden text-center py-4">
        <div class="inline-block w-8 h-8 border-4 border-t-transparent rounded-full animate-spin border-[#8B4513]"></div>
        <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...</p>
      </div>
    </div>
  </div>

  <div id="submitWorkModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="rounded-lg shadow-2xl p-6 w-full max-w-md bg-white text-theme-brown border-4 border-[#FFD700]">
      <h3 class="text-2xl font-bold mb-4">‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h3>
      <form id="submitWorkForm" class="space-y-4">
        <div>
          <label for="workTitle" class="block text-sm font-semibold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label> 
          <input type="text" id="workTitle" required class="w-full px-4 py-2 border-2 border-[#D4AF37] rounded-lg focus:outline-none focus:ring-2 bg-[#FFFAF0]">
        </div>
        <div>
          <label for="workContent" class="block text-sm font-semibold mb-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡∏Å‡∏ß‡∏µ</label> 
          <textarea id="workContent" required rows="6" class="w-full px-4 py-2 border-2 border-[#D4AF37] rounded-lg focus:outline-none focus:ring-2 resize-none bg-[#FFFAF0]"></textarea>
        </div>
        <div class="flex gap-3 mt-6">
          <button type="submit" id="submitWorkSubmitBtn" class="flex-1 bg-theme-gold py-3 px-6 font-bold rounded-lg shadow hover:scale-105"> ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô </button> 
          <button type="button" id="cancelWorkBtn" class="flex-1 bg-gray-300 text-gray-700 py-3 px-6 font-bold rounded-lg shadow hover:scale-105"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
        </div>
      </form>
      <div id="workLoading" class="hidden text-center py-4">
        <div class="inline-block w-8 h-8 border-4 border-t-transparent rounded-full animate-spin border-[#8B4513]"></div>
        <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô...</p>
      </div>
    </div>
  </div>

  <div id="commentsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[90%] overflow-y-auto bg-white text-theme-brown border-4 border-[#FFD700]">
      <h3 class="text-2xl font-bold mb-4">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</h3>
      <div id="commentsList" class="space-y-3 mb-4 max-h-64 overflow-y-auto p-2 bg-[#FFFAF0] rounded-lg border border-[#D4AF37]"></div>
      <div id="addCommentSection">
        <textarea id="newComment" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..." rows="3" class="w-full px-4 py-2 border-2 border-[#D4AF37] rounded-lg focus:outline-none focus:ring-2 resize-none mb-3 bg-white"></textarea>
        <div class="flex gap-3">
          <button id="submitCommentBtn" class="flex-1 bg-theme-gold py-2 px-4 font-bold rounded-lg shadow hover:scale-105"> ‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô </button> 
          <button id="closeCommentsBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 font-bold rounded-lg shadow hover:scale-105"> ‡∏õ‡∏¥‡∏î </button>
        </div>
      </div>
      <div id="commentLoading" class="hidden text-center py-4">
        <div class="inline-block w-6 h-6 border-4 border-t-transparent rounded-full animate-spin border-[#8B4513]"></div>
      </div>
    </div>
  </div>

  <div id="guestAlertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="rounded-lg shadow-2xl p-6 w-full max-w-md text-center bg-white text-theme-brown border-4 border-[#FFD700]">
      <h3 class="text-xl font-bold mb-4">‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô</h3>
      <p class="mb-6 text-gray-700">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ</p>
      <div class="flex gap-3">
        <button id="goToRegisterBtn" class="flex-1 bg-theme-gold py-3 px-6 font-bold rounded-lg shadow hover:scale-105"> ‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô </button> 
        <button id="closeGuestAlertBtn" class="flex-1 bg-gray-300 text-gray-700 py-3 px-6 font-bold rounded-lg shadow hover:scale-105"> ‡∏õ‡∏¥‡∏î </button>
      </div>
    </div>
  </div>

  <div id="toast" class="hidden fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all text-white font-semibold"></div>

  <script>
    // --- Configuration & Constants ---
    // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á App Script ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxz2rxiHgeeV8fffc21Z0dhtj21V7519a33j1ekaEs258QDmdcjRTnnMABm3_7B0mXT/exec';
    
    let currentWorkId = null;
    let allWorks = [];

    // --- Utility Functions ---

    function playSFX(sfxNumber) {
      const audio = document.getElementById(`sfx${sfxNumber}`);
      if (audio) {
        audio.currentTime = 0;
        audio.play().catch(e => console.log('Audio play failed:', e));
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const bgColor = type === 'success' ? '#10b981' : '#ef4444';
      toast.style.backgroundColor = bgColor;
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function showPage(pageNumber) {
      document.getElementById('page1').classList.add('hidden');
      document.getElementById('page2').classList.add('hidden');
      document.getElementById('page3').classList.add('hidden');
      document.getElementById(`page${pageNumber}`).classList.remove('hidden');
    }

    function showModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }

    function hideModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    function getUserId() {
      return localStorage.getItem('user_id');
    }

    function getUserName() {
      return localStorage.getItem('user_name') || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
    }
    
    function logout() {
        localStorage.removeItem('user_id');
        localStorage.removeItem('user_name');
        location.reload();
    }

    // --- API Communication ---

    async function callAppScript(action, data) {
      if (!APP_SCRIPT_URL) {
        throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ App Script URL ‡∏Å‡πà‡∏≠‡∏ô');
      }
      
      const response = await fetch(APP_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action, ...data })
      });
      
      if (!response.ok) throw new Error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
      return await response.json();
    }

    // --- Event Handlers ---

    async function handleRegister(e) {
      e.preventDefault();
      playSFX(1);
      
      const form = document.getElementById('registerForm');
      const loading = document.getElementById('registerLoading');
      
      form.classList.add('hidden');
      loading.classList.remove('hidden');
      
      try {
        const formData = {
          ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤: document.getElementById('prefix').value,
          ‡∏ä‡∏∑‡πà‡∏≠: document.getElementById('firstName').value,
          ‡∏™‡∏Å‡∏∏‡∏•: document.getElementById('lastName').value,
          ‡∏ä‡∏±‡πâ‡∏ô: document.getElementById('grade').value,
          ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: document.getElementById('studentNumber').value
        };
        
        const result = await callAppScript('register', { data: formData });
        
        if (result.success) {
          localStorage.setItem('user_id', result.user_id);
          localStorage.setItem('user_name', `${formData.‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤}${formData.‡∏ä‡∏∑‡πà‡∏≠} ${formData.‡∏™‡∏Å‡∏∏‡∏•}`);
          
          showToast('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          hideModal('registerModal');
          updateWelcomeMessage();
          showPage(2);
        } else {
          showToast(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
      } catch (error) {
        console.error(error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', 'error');
      } finally {
        form.classList.remove('hidden');
        loading.classList.add('hidden');
        form.reset();
      }
    }

    async function handleSubmitWork(e) {
      e.preventDefault();
      playSFX(1);
      
      const userId = getUserId();
      if (!userId) {
        showGuestAlert();
        return;
      }
      
      const form = document.getElementById('submitWorkForm');
      const loading = document.getElementById('workLoading');
      
      form.classList.add('hidden');
      loading.classList.remove('hidden');
      
      try {
        const workData = {
          user_id: userId,
          ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: document.getElementById('workTitle').value,
          ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡∏Å‡∏ß‡∏µ: document.getElementById('workContent').value
        };
        
        const result = await callAppScript('submitWork', { data: workData });
        
        if (result.success) {
          showToast('‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          hideModal('submitWorkModal');
          form.reset();
        } else {
          showToast(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô', 'error');
      } finally {
        form.classList.remove('hidden');
        loading.classList.add('hidden');
      }
    }

    async function loadExhibition() {
      const loading = document.getElementById('loadingExhibition');
      const grid = document.getElementById('exhibitionGrid');
      
      loading.classList.remove('hidden');
      grid.innerHTML = '';
      
      const userId = getUserId() || "";

      try {
        const result = await callAppScript('getData', { data: { user_id: userId } });
        
        if (result.success && result.data) {
          allWorks = result.data;
          renderWorks(allWorks);
        } else {
          grid.innerHTML = '<p class="text-center col-span-full">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô</p>';
        }
      } catch (error) {
        console.log(error);
        grid.innerHTML = '<p class="text-center col-span-full text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏á‡∏≤‡∏ô</p>';
      } finally {
        loading.classList.add('hidden');
      }
    }

    function renderWorks(works) {
      const grid = document.getElementById('exhibitionGrid');
      grid.innerHTML = '';
      
      works.forEach(work => {
        const card = document.createElement('div');
        card.className = 'masonry-item p-5 rounded-lg shadow-lg transition-all hover:shadow-xl bg-white text-[#8B4513] border border-[#ffecd1]';
        
        if (work.is_top3) {
          card.classList.add('golden-glow');
          card.style.background = `linear-gradient(135deg, #FFFFFF 0%, #FFF9E6 100%)`;
          card.style.border = `3px solid #FFD700`;
        }
        
        const crown = work.is_top3 ? '<span class="text-2xl mr-2">üëë</span>' : '';
        
        card.innerHTML = `
          ${crown ? `<div class="mb-2">${crown}</div>` : ''}
          <h3 class="text-xl font-bold mb-2 break-words text-[#8B4513]">${work.‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á}</h3>
          <p class="text-sm mb-4 whitespace-pre-wrap leading-relaxed text-gray-700">${work.‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡∏Å‡∏ß‡∏µ}</p>
          <div class="border-t border-gray-200 pt-3 mb-3">
             <p class="text-xs font-semibold text-[#D4AF37]">‡πÇ‡∏î‡∏¢: ${work.‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á} (${work.‡∏ä‡∏±‡πâ‡∏ô})</p>
          </div>
          <div class="flex items-center justify-between mt-2">
            <button class="like-btn flex items-center gap-2 px-3 py-2 rounded-lg font-semibold transition-all hover:scale-110 bg-[#D4AF37] text-white" data-work-id="${work.work_id}">
              <span class="heart-icon text-xl ${work.is_liked ? 'heart-liked' : ''}">${work.is_liked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
              <span class="like-count">${work.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à}</span>
            </button>
            <button class="comment-btn px-3 py-2 rounded-lg font-semibold transition-all hover:scale-105 bg-[#FFD700] text-[#8B4513]" data-work-id="${work.work_id}">
              üí¨ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (${work.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô ? work.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô.length : 0})
            </button>
          </div>
        `;
        
        grid.appendChild(card);
      });
      
      attachWorkEventListeners();
    }

    function attachWorkEventListeners() {
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', handleLike);
      });
      
      document.querySelectorAll('.comment-btn').forEach(btn => {
        btn.addEventListener('click', handleOpenComments);
      });
    }

    async function handleLike(e) {
      e.preventDefault();
      playSFX(3);
      
      const userId = getUserId();
      if (!userId) {
        showGuestAlert();
        return;
      }
      
      const btn = e.currentTarget;
      const workId = btn.dataset.workId;
      const heartIcon = btn.querySelector('.heart-icon');
      const likeCount = btn.querySelector('.like-count');
      
      btn.disabled = true;
      
      try {
        const result = await callAppScript('likeWork', { 
          data: {
            user_id: userId, 
            work_id: workId 
          }
        });
        
        if (result.success) {
          heartIcon.textContent = '‚ù§Ô∏è';
          heartIcon.classList.add('heart-liked');
          likeCount.textContent = result.new_likes;
        } else {
             showToast(result.message, 'error');
        }
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      } finally {
        btn.disabled = false;
      }
    }

    async function handleOpenComments(e) {
      e.preventDefault();
      playSFX(4);
      
      const userId = getUserId();
      if (!userId) {
        showGuestAlert();
        return;
      }
      
      const workId = e.currentTarget.dataset.workId;
      currentWorkId = workId;
      
      showModal('commentsModal');
      renderComments(workId);
    }

    function renderComments(workId) {
      const commentsList = document.getElementById('commentsList');
      commentsList.innerHTML = '';
      
      const work = allWorks.find(w => w.work_id === workId);
      
      if (work && work.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô && work.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô.length > 0) {
        work.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô.forEach(comment => {
          const commentDiv = document.createElement('div');
          commentDiv.className = 'p-3 rounded-lg border border-[#D4AF37] mb-2 bg-white';
          commentDiv.innerHTML = `
            <p class="font-semibold text-sm text-[#8B4513]">${comment.‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô}</p>
            <p class="text-sm mt-1 text-gray-700">${comment.‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°}</p>
          `;
          commentsList.appendChild(commentDiv);
        });
      } else {
        commentsList.innerHTML = '<p class="text-center text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</p>';
      }
    }

    async function handleAddComment(e) {
      e.preventDefault();
      
      const userId = getUserId();
      if (!userId || !currentWorkId) return;
      
      const textarea = document.getElementById('newComment');
      const commentText = textarea.value.trim();
      
      if (!commentText) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô', 'error');
        return;
      }
      
      const loading = document.getElementById('commentLoading');
      loading.classList.remove('hidden');
      
      try {
        const result = await callAppScript('addComment', {
          data: {
            user_id: userId,
            work_id: currentWorkId,
            ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: commentText
          }
        });
        
        if (result.success) {
          showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          textarea.value = '';
          
          const dataResult = await callAppScript('getData', { data: { user_id: userId } });
          if(dataResult.success) {
              allWorks = dataResult.data;
              renderComments(currentWorkId);
              renderWorks(allWorks); 
          }
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
      } catch (error) {
        console.error(error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
      } finally {
        loading.classList.add('hidden');
      }
    }

    function showGuestAlert() {
      showModal('guestAlertModal');
    }

    function updateWelcomeMessage() {
      const userName = getUserName();
      const welcomeMsg = document.getElementById('welcomeMsg');
      if (welcomeMsg) {
        welcomeMsg.textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${userName}`;
      }
    }

    // --- Initialization ---

    document.addEventListener('DOMContentLoaded', () => {
        // Event Listeners
        document.getElementById('visitBtn').addEventListener('click', () => {
          playSFX(2);
          showPage(3);
          loadExhibition();
        });

        document.getElementById('registerBtn').addEventListener('click', () => {
          playSFX(1);
          showModal('registerModal');
        });

        document.getElementById('cancelRegisterBtn').addEventListener('click', () => {
          hideModal('registerModal');
          document.getElementById('registerForm').reset();
        });

        document.getElementById('registerForm').addEventListener('submit', handleRegister);

        document.getElementById('visitExhibitionBtn').addEventListener('click', () => {
          playSFX(2);
          showPage(3);
          loadExhibition();
        });

        document.getElementById('submitWorkBtn').addEventListener('click', () => {
          playSFX(1);
          showModal('submitWorkModal');
        });

        document.getElementById('cancelWorkBtn').addEventListener('click', () => {
          hideModal('submitWorkModal');
          document.getElementById('submitWorkForm').reset();
        });

        document.getElementById('submitWorkForm').addEventListener('submit', handleSubmitWork);

        document.getElementById('submitCommentBtn').addEventListener('click', handleAddComment);

        document.getElementById('closeCommentsBtn').addEventListener('click', () => {
          hideModal('commentsModal');
          document.getElementById('newComment').value = '';
          currentWorkId = null;
        });

        document.getElementById('goToRegisterBtn').addEventListener('click', () => {
          hideModal('guestAlertModal');
          showPage(1);
        });

        document.getElementById('closeGuestAlertBtn').addEventListener('click', () => {
          hideModal('guestAlertModal');
        });

        // Check Login Status
        if (getUserId()) {
          showPage(2);
          updateWelcomeMessage();
        }
    });

  </script>
</body>
</html>
