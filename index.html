<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏•‡∏≤‡∏ô‡∏ô‡∏¥‡∏ó‡∏£‡∏£‡∏®‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏â‡∏±‡∏ô‡∏ó‡πå ‡πë‡πë</title>
  
  <link rel="icon" type="image/png" href="https://nonthaphathr.github.io/uploadimg/logokhampraphan-non.png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Charm:wght@400;700&family=Prompt:wght@300;400;600&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-cream: #FDFBF7;
      --card-bg: #FFFFFF;
      --text-main: #2D1B0E;
      --gold-accent: #FFD700;
      --brown-accent: #8B4513;
    }

    body { font-family: 'Prompt', sans-serif; background-color: var(--bg-cream); color: var(--text-main); overflow-x: hidden; }
    
    /* ‚úÖ 2. ‡πÅ‡∏Å‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢ */
    .modern-title {
      font-family: 'Charm', cursive;
      background: linear-gradient(45deg, #8B4513, #D4AF37);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1)); /* ‡πÉ‡∏ä‡πâ filter ‡πÅ‡∏ó‡∏ô drop-shadow ‡πÄ‡∏î‡∏¥‡∏° */
      line-height: 1.8; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∞‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î */
      padding-top: 10px; /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
      padding-bottom: 10px; /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
      display: inline-block; /* ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô */
      width: 100%;
    }

    .poet-font { font-family: 'Sarabun', sans-serif; }

    /* Paper Card Style */
    .paper-card {
      background-color: var(--card-bg);
      border: 1px solid #E5E0D0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: visible !important; 
    }
    .paper-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1);
      border-color: var(--gold-accent);
      z-index: 10;
    }
    
    .golden-glow {
      border: 2px solid var(--gold-accent);
      background: linear-gradient(180deg, #FFFFFF 0%, #FFFDF0 100%);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }
    
    .crown-icon {
        position: absolute;
        top: -15px;
        right: -15px;
        font-size: 2.5rem;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        z-index: 20;
        animation: bounce-slow 2s infinite;
    }
    @keyframes bounce-slow { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-5px);} }

    .heart-liked { color: #ef4444; animation: heart-pop 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.49); }
    @keyframes heart-pop { 0% {transform: scale(1);} 50% {transform: scale(1.5);} 100% {transform: scale(1);} }
    
    .fade-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

    .firefly {
      position: absolute;
      width: 4px; height: 4px;
      background-color: #FFD700;
      border-radius: 50%;
      box-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700;
      animation: fly 10s linear infinite;
      opacity: 0;
      pointer-events: none;
      z-index: 0;
    }
    @keyframes fly {
      0% { opacity: 0; transform: translate(0, 0); }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translate(var(--moveX), var(--moveY)); }
    }

    .masonry-grid { column-count: 1; column-gap: 2rem; }
    @media (min-width: 768px) { .masonry-grid { column-count: 2; } }
    @media (min-width: 1024px) { .masonry-grid { column-count: 3; } }
    .masonry-item { break-inside: avoid; margin-bottom: 2rem; }
  </style>
</head>

<body class="min-h-full text-gray-800">
  <audio id="sfx1" src="https://nonthaphathr.github.io/uploadimg/toggle-button.mp3"></audio>
  <audio id="sfx2" src="https://nonthaphathr.github.io/uploadimg/openexhibition.mp3"></audio>
  <audio id="sfx3" src="https://nonthaphathr.github.io/uploadimg/heartclick.mp3"></audio>
  <audio id="sfx4" src="https://nonthaphathr.github.io/uploadimg/commentpoet.mp3"></audio>

  <div id="page1" class="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden bg-[#FDFBF7]">
    <div class="absolute inset-0 z-0 opacity-20" style="background-image: url('https://www.transparenttextures.com/patterns/thai-pattern.png');"></div>
    
    <img src="https://nonthaphathr.github.io/uploadimg/logokhampraphan-non.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="w-48 h-48 mb-6 object-contain z-10 drop-shadow-xl animate-bounce-slow">
    
    <h1 class="text-4xl md:text-6xl font-bold text-center mb-2 modern-title z-10">‡∏•‡∏≤‡∏ô‡∏ô‡∏¥‡∏ó‡∏£‡∏£‡∏®‡∏Å‡∏≤‡∏£</h1>
    <h2 class="text-2xl md:text-4xl text-center mb-8 modern-title z-10" style="font-weight: 400;">‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏â‡∏±‡∏ô‡∏ó‡πå ‡πë‡πë</h2>
    
    <div class="flex flex-col gap-4 w-full max-w-md z-10 mt-4">
      <button id="visitBtn" class="bg-white hover:bg-[#FFFDF5] text-[#8B4513] w-full py-4 px-6 text-xl font-bold rounded-xl shadow-lg border-2 border-[#D4AF37] transition-all hover:scale-105">
        üëÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ô‡∏¥‡∏ó‡∏£‡∏£‡∏®‡∏Å‡∏≤‡∏£
      </button> 
      <button id="registerBtn" class="bg-gradient-to-r from-[#D4AF37] to-[#B48E25] text-white w-full py-4 px-6 text-xl font-bold rounded-xl shadow-lg transition-all hover:scale-105 hover:shadow-2xl">
        ‚úçÔ∏è ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô
      </button>
    </div>
  </div>

  <div id="page2" class="hidden min-h-screen flex flex-col items-center justify-center p-6 fade-in bg-[#FDFBF7]">
    <div class="w-full max-w-lg bg-white p-8 rounded-2xl shadow-2xl border border-yellow-100 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-300 to-yellow-600"></div>
        <img src="https://nonthaphathr.github.io/uploadimg/logokhampraphan-non.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="w-20 h-20 mx-auto mb-4">
        <h2 id="welcomeMsg" class="text-2xl font-bold text-center mb-8 text-[#5D4037]">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
        <div class="space-y-4">
            <button id="visitExhibitionBtn" class="bg-[#D4AF37] text-white w-full py-4 text-lg font-bold rounded-xl shadow-md hover:bg-[#B48E25] transition-all">üèõÔ∏è ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏•‡∏≤‡∏ô‡∏ô‡∏¥‡∏ó‡∏£‡∏£‡∏®‡∏Å‡∏≤‡∏£</button> 
            <button id="submitWorkBtn" class="bg-white text-[#5D4037] border-2 border-[#D4AF37] w-full py-4 text-lg font-bold rounded-xl shadow-sm hover:bg-yellow-50 transition-all">üìù ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        <button onclick="logout()" class="w-full text-center mt-6 text-gray-400 hover:text-red-500 text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>

  <div id="page3" class="hidden min-h-screen p-6 pb-20 relative bg-[#FAF9F6]">
    <div id="fireflies-container" class="absolute inset-0 overflow-hidden pointer-events-none z-0"></div>

    <div class="sticky top-0 z-40 bg-[#FAF9F6]/95 backdrop-blur-md py-3 mb-6 border-b border-yellow-200 flex justify-between items-center px-2">
        <div class="flex items-center gap-3">
            <img src="https://nonthaphathr.github.io/uploadimg/logokhampraphan-non.png" class="w-10 h-10">
            <h2 class="text-xl md:text-2xl font-bold modern-title text-[1.5rem]" style="margin-bottom: 0;">‡∏•‡∏≤‡∏ô‡∏à‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á</h2>
        </div>
        <button onclick="location.reload()" class="bg-[#5D4037] text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg hover:bg-[#3E2723]">üè† ‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
    
    <div id="loadingExhibition" class="text-center py-20 relative z-10">
      <div class="inline-block w-12 h-12 border-4 border-[#D4AF37] border-t-transparent rounded-full animate-spin"></div>
      <p class="mt-4 text-[#8B4513] animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏á‡∏≤‡∏ô...</p>
    </div>

    <div id="emptyState" class="hidden text-center py-20 relative z-10 fade-in">
        <div class="text-6xl mb-4 grayscale opacity-50">üìú</div>
        <h3 class="text-xl font-bold text-gray-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h3>
        <button onclick="showModal('submitWorkModal')" class="mt-4 text-[#D4AF37] font-bold underline">‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å</button>
    </div>
    
    <div id="exhibitionGrid" class="masonry-grid max-w-7xl mx-auto relative z-10 pt-4"></div>
  </div>

  <div id="registerModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
      <h3 class="text-xl font-bold mb-4 text-center">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
      <form id="registerForm" class="space-y-3">
        <select id="prefix" required class="w-full p-3 border rounded-lg bg-gray-50"><option value="">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</option><option value="‡∏î.‡∏ä.">‡∏î.‡∏ä.</option><option value="‡∏î.‡∏ç.">‡∏î.‡∏ç.</option><option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option><option value="‡∏ô.‡∏™.">‡∏ô.‡∏™.</option></select>
        <input id="firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠" required class="w-full p-3 border rounded-lg bg-gray-50">
        <input id="lastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required class="w-full p-3 border rounded-lg bg-gray-50">
        <div class="flex gap-2"><select id="grade" required class="w-1/2 p-3 border rounded-lg bg-gray-50"><option value="">‡∏ä‡∏±‡πâ‡∏ô</option><option>‡∏°.1</option><option>‡∏°.2</option><option>‡∏°.3</option><option>‡∏°.4</option><option>‡∏°.5</option><option>‡∏°.6</option></select>
        <input type="number" id="studentNumber" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" required class="w-1/2 p-3 border rounded-lg bg-gray-50"></div>
        <div class="flex gap-2 mt-4"><button type="submit" class="flex-1 bg-[#D4AF37] text-white p-3 rounded-lg font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button><button type="button" onclick="hideModal('registerModal')" class="flex-1 bg-gray-200 p-3 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
      </form>
      <div id="registerLoading" class="hidden text-center p-4 text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</div>
    </div>
  </div>

  <div id="submitWorkModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
      <h3 class="text-xl font-bold mb-4 text-center">‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h3>
      <form id="submitWorkForm" class="space-y-3">
        <input id="workTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" required class="w-full p-3 border rounded-lg bg-gray-50 font-bold text-[#5D4037]">
        <textarea id="workContent" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡∏Å‡∏ß‡∏µ..." required rows="6" class="w-full p-3 border rounded-lg bg-gray-50 font-sarabun text-lg leading-relaxed"></textarea>
        <div class="flex gap-2 mt-4"><button type="submit" class="flex-1 bg-[#D4AF37] text-white p-3 rounded-lg font-bold">‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô</button><button type="button" onclick="hideModal('submitWorkModal')" class="flex-1 bg-gray-200 p-3 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
      </form>
      <div id="workLoading" class="hidden text-center p-4 text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...</div>
    </div>
  </div>

  <div id="commentsModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg h-[80vh] flex flex-col">
      <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-lg">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</h3><button onclick="hideModal('commentsModal')" class="text-2xl">&times;</button></div>
      <div id="commentsList" class="flex-1 overflow-y-auto space-y-3 p-2 bg-gray-50 rounded-lg mb-4"></div>
      
      <div id="commentInputSection" class="flex gap-2">
        <input id="newComment" placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô..." class="flex-1 p-3 border rounded-lg outline-none focus:ring-2 ring-yellow-400">
        <button onclick="handleAddComment()" id="sendCommentBtn" class="bg-[#D4AF37] text-white px-4 rounded-lg font-bold">‡∏™‡πà‡∏á</button>
      </div>
      <div id="guestCommentNotice" class="hidden text-center p-2 text-gray-500 text-sm bg-gray-100 rounded-lg">
         üîí ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
      </div>
    </div>
  </div>

  <div id="guestAlertModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-6 rounded-xl text-center shadow-2xl max-w-xs">
        <div class="text-4xl mb-2">üîí</div>
        <p class="mb-4 font-bold">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô</p>
        <button onclick="hideModal('guestAlertModal'); showModal('registerModal')" class="w-full bg-[#D4AF37] text-white p-3 rounded-lg font-bold mb-2">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        <button onclick="hideModal('guestAlertModal')" class="text-gray-400 text-sm">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <div id="toast" class="hidden fixed top-6 right-6 px-6 py-4 rounded-xl shadow-xl z-[100] text-white font-bold transition-all transform translate-y-[-20px] opacity-0"></div>

  <script>
    // ‚öôÔ∏è SETUP
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxz2rxiHgeeV8fffc21Z0dhtj21V7519a33j1ekaEs258QDmdcjRTnnMABm3_7B0mXT/exec'; 
    let currentWorkId = null;
    let allWorks = [];

    // üîä SFX & UI
    const playSFX = (id) => document.getElementById(`sfx${id}`)?.play().catch(()=>{});
    const showModal = (id) => document.getElementById(id).classList.remove('hidden');
    const hideModal = (id) => document.getElementById(id).classList.add('hidden');
    
    function showToast(msg, type='success') {
        const t = document.getElementById('toast');
        t.className = `fixed top-6 right-6 px-6 py-3 rounded-xl shadow-xl z-[100] text-white font-bold transition-all duration-300 ${type==='success'?'bg-green-600':'bg-red-500'}`;
        t.innerHTML = msg;
        t.classList.remove('hidden', 'opacity-0', 'translate-y-[-20px]');
        setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-20px]'), 3000);
        setTimeout(() => t.classList.add('hidden'), 3500);
    }

    // ü¶ã Create Fireflies
    function createFireflies() {
        const container = document.getElementById('fireflies-container');
        container.innerHTML = '';
        for(let i=0; i<15; i++) {
            const f = document.createElement('div');
            f.className = 'firefly';
            f.style.left = Math.random()*100 + '%';
            f.style.top = Math.random()*100 + '%';
            f.style.setProperty('--moveX', (Math.random()*200 - 100) + 'px');
            f.style.setProperty('--moveY', (Math.random()*200 - 100) + 'px');
            f.style.animationDelay = (Math.random()*5) + 's';
            f.style.animationDuration = (10 + Math.random()*10) + 's';
            container.appendChild(f);
        }
    }

    // üì° API
    async function callAPI(action, data) {
        if(!APP_SCRIPT_URL) return showToast('Error: No URL', 'error');
        try {
            const res = await fetch(APP_SCRIPT_URL, { method: 'POST', body: JSON.stringify({action, data}) });
            return await res.json();
        } catch(e) { 
            console.error(e);
            return {success: false, message: 'Connection Failed'}; 
        }
    }

    // üéÆ Logic
    async function handleRegister(e) {
        e.preventDefault(); playSFX(1);
        document.getElementById('registerForm').classList.add('hidden');
        document.getElementById('registerLoading').classList.remove('hidden');
        
        const data = {
            ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤: document.getElementById('prefix').value,
            ‡∏ä‡∏∑‡πà‡∏≠: document.getElementById('firstName').value,
            ‡∏™‡∏Å‡∏∏‡∏•: document.getElementById('lastName').value,
            ‡∏ä‡∏±‡πâ‡∏ô: document.getElementById('grade').value,
            ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: document.getElementById('studentNumber').value
        };
        const res = await callAPI('register', data);
        
        if(res.success) {
            localStorage.setItem('user_id', res.user_id);
            localStorage.setItem('user_name', data.‡∏ä‡∏∑‡πà‡∏≠);
            showToast('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            location.reload();
        } else {
            showToast(res.message, 'error');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('registerLoading').classList.add('hidden');
        }
    }

    async function handleSubmitWork(e) {
        e.preventDefault(); playSFX(1);
        document.getElementById('submitWorkForm').classList.add('hidden');
        document.getElementById('workLoading').classList.remove('hidden');

        const res = await callAPI('submitWork', {
            user_id: localStorage.getItem('user_id'),
            ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: document.getElementById('workTitle').value,
            ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡∏Å‡∏ß‡∏µ: document.getElementById('workContent').value
        });

        if(res.success) {
            showToast('‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
            hideModal('submitWorkModal');
            document.getElementById('submitWorkForm').reset();
        } else {
            showToast(res.message, 'error');
        }
        document.getElementById('submitWorkForm').classList.remove('hidden');
        document.getElementById('workLoading').classList.add('hidden');
    }

    async function loadExhibition() {
        document.getElementById('loadingExhibition').classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        const grid = document.getElementById('exhibitionGrid');
        grid.innerHTML = '';

        const res = await callAPI('getData', { user_id: localStorage.getItem('user_id') });
        document.getElementById('loadingExhibition').classList.add('hidden');

        if(res.success && res.data.length > 0) {
            allWorks = res.data;
            res.data.forEach((work, i) => {
                const div = document.createElement('div');
                div.className = `masonry-item paper-card rounded-xl p-6 mb-6 fade-in ${work.is_top3 ? 'golden-glow' : ''}`;
                div.style.animationDelay = i*0.1 + 's';
                
                div.innerHTML = `
                    ${work.is_top3 ? '<div class="crown-icon">üëë</div>' : ''}
                    <h3 class="text-xl font-bold text-[#2D1B0E] mb-1 break-words">${work.‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á}</h3>
                    <p class="text-xs text-[#B48E25] font-bold mb-4 border-b pb-2 border-gray-100">‡πÇ‡∏î‡∏¢ ${work.‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á} (${work.‡∏ä‡∏±‡πâ‡∏ô})</p>
                    <p class="poet-font text-lg text-gray-800 leading-relaxed whitespace-pre-wrap pl-4 border-l-4 border-yellow-200 mb-4">${work.‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡∏Å‡∏ß‡∏µ}</p>
                    <div class="flex gap-2 pt-2">
                        <button onclick="toggleLike('${work.work_id}', this)" class="like-btn flex-1 py-2 rounded-lg border hover:bg-red-50 flex items-center justify-center gap-2 transition-colors ${work.is_liked ? 'border-red-200 bg-red-50' : 'border-gray-200'}">
                            <span class="text-xl heart-icon ${work.is_liked ? 'heart-liked' : 'grayscale opacity-50'}">‚ù§Ô∏è</span>
                            <span class="font-bold text-gray-600 count">${work.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à}</span>
                        </button>
                        <button onclick="openComments('${work.work_id}')" class="flex-1 py-2 rounded-lg border border-gray-200 hover:bg-yellow-50 text-gray-600 font-bold flex items-center justify-center gap-2">
                            üí¨ ${work.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô ? work.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô.length : 0}
                        </button>
                    </div>
                `;
                grid.appendChild(div);
            });
        } else {
            document.getElementById('emptyState').classList.remove('hidden');
        }
    }

    async function toggleLike(workId, btn) {
        if(!localStorage.getItem('user_id')) return showModal('guestAlertModal');
        playSFX(3);
        
        btn.disabled = true;
        const icon = btn.querySelector('.heart-icon');
        const countSpan = btn.querySelector('.count');
        const currentCount = parseInt(countSpan.innerText);
        const isLiked = icon.classList.contains('heart-liked');

        if(isLiked) {
            icon.classList.remove('heart-liked'); icon.classList.add('grayscale', 'opacity-50');
            btn.classList.remove('border-red-200', 'bg-red-50');
            countSpan.innerText = Math.max(0, currentCount - 1);
        } else {
            icon.classList.remove('grayscale', 'opacity-50'); icon.classList.add('heart-liked');
            btn.classList.add('border-red-200', 'bg-red-50');
            countSpan.innerText = currentCount + 1;
        }

        const res = await callAPI('likeWork', { user_id: localStorage.getItem('user_id'), work_id: workId });
        
        if(res.success) {
            countSpan.innerText = res.new_likes;
        }
        btn.disabled = false;
    }

    function openComments(workId) {
        playSFX(4);
        currentWorkId = workId;
        const work = allWorks.find(w => w.work_id == workId);
        const list = document.getElementById('commentsList');
        list.innerHTML = '';
        
        if(work.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô) {
            work.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô.forEach(c => {
                list.innerHTML += `<div class="bg-white p-3 rounded-lg border mb-2 shadow-sm"><div class="text-xs font-bold text-[#D4AF37]">${c.commenter_name}</div><div class="text-gray-700">${c.comment_text}</div></div>`;
            });
            if(work.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô.length === 0) list.innerHTML = `<div class="text-center text-gray-400 mt-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</div>`;
        }

        if(localStorage.getItem('user_id')) {
            document.getElementById('commentInputSection').classList.remove('hidden');
            document.getElementById('guestCommentNotice').classList.add('hidden');
        } else {
            document.getElementById('commentInputSection').classList.add('hidden');
            document.getElementById('guestCommentNotice').classList.remove('hidden');
        }
        
        showModal('commentsModal');
    }

    async function handleAddComment() {
        if(!localStorage.getItem('user_id')) return;
        const txt = document.getElementById('newComment');
        if(!txt.value.trim()) return;
        
        const btn = document.getElementById('sendCommentBtn');
        btn.innerText = '...'; btn.disabled = true;

        const res = await callAPI('addComment', { 
            user_id: localStorage.getItem('user_id'), 
            work_id: currentWorkId, 
            text: txt.value
        });

        if(res.success) {
            txt.value = '';
            showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
            hideModal('commentsModal');
            loadExhibition();
        } else {
            showToast('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        }
        btn.innerText = '‡∏™‡πà‡∏á'; btn.disabled = false;
    }

    function logout() { localStorage.clear(); location.reload(); }

    window.onload = () => {
        if(localStorage.getItem('user_id')) {
            document.getElementById('page1').classList.add('hidden');
            document.getElementById('page2').classList.remove('hidden');
            document.getElementById('welcomeMsg').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${localStorage.getItem('user_name')}`;
        }
        
        document.getElementById('registerForm').addEventListener('submit', handleRegister);
        document.getElementById('submitWorkForm').addEventListener('submit', handleSubmitWork);
        
        document.getElementById('visitBtn').onclick = () => { 
            playSFX(2); 
            document.getElementById('page1').classList.add('hidden'); 
            document.getElementById('page3').classList.remove('hidden'); 
            loadExhibition(); 
            createFireflies(); 
        };
        document.getElementById('visitExhibitionBtn').onclick = () => { 
            playSFX(2); 
            document.getElementById('page2').classList.add('hidden'); 
            document.getElementById('page3').classList.remove('hidden'); 
            loadExhibition(); 
            createFireflies(); 
        };

        document.getElementById('registerBtn').onclick = () => { playSFX(1); showModal('registerModal'); };
        document.getElementById('submitWorkBtn').onclick = () => { playSFX(1); showModal('submitWorkModal'); };
    };
  </script>
</body>
</html>
